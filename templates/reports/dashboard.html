{% extends "base.html" %}

{% block title %}التقارير والإقرارات الضريبية - نظام إدارة الإقرارات الضريبية{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="gradient-text mb-4">
            <i class="fas fa-chart-bar me-3"></i>
            التقارير والإقرارات الضريبية
        </h1>
    </div>
</div>

<!-- إحصائيات سريعة -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="stats-icon">
                <i class="fas fa-file-invoice"></i>
            </div>
            <div class="stats-number">{{ total_invoices|default(0) }}</div>
            <div class="stats-label">إجمالي الفواتير</div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card success">
            <div class="stats-icon">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="stats-number">{{ "{:,.0f}".format(total_vat|default(0)) }}</div>
            <div class="stats-label">ضريبة القيمة المضافة (جنيه)</div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card warning">
            <div class="stats-icon">
                <i class="fas fa-cut"></i>
            </div>
            <div class="stats-number">{{ "{:,.0f}".format(total_withholding|default(0)) }}</div>
            <div class="stats-label">ضريبة الخصم والإضافة (جنيه)</div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card info">
            <div class="stats-icon">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="stats-number">{{ "{:,.0f}".format(total_sales|default(0)) }}</div>
            <div class="stats-label">إجمالي المبيعات (جنيه)</div>
        </div>
    </div>
</div>

<div class="row">
    <!-- أنواع التقارير -->
    <div class="col-xl-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-alt me-2"></i>
                    أنواع التقارير المتاحة
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- تقرير ضريبة القيمة المضافة -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-percentage fa-3x text-primary"></i>
                                </div>
                                <h6 class="card-title">تقرير ضريبة القيمة المضافة</h6>
                                <p class="card-text text-muted small">
                                    تقرير شامل بجميع فواتير ضريبة القيمة المضافة (14%)
                                </p>
                                <div class="btn-group w-100">
                                    <a href="{{ url_for('reports.vat_report') }}" class="btn btn-primary">
                                        <i class="fas fa-eye me-1"></i>عرض
                                    </a>
                                    <a href="{{ url_for('reports.vat_report', export='pdf') }}" class="btn btn-outline-primary">
                                        <i class="fas fa-file-pdf me-1"></i>PDF
                                    </a>
                                    <a href="{{ url_for('reports.vat_report', export='excel') }}" class="btn btn-outline-primary">
                                        <i class="fas fa-file-excel me-1"></i>Excel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- تقرير ضريبة الخصم والإضافة -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-cut fa-3x text-warning"></i>
                                </div>
                                <h6 class="card-title">تقرير ضريبة الخصم والإضافة</h6>
                                <p class="card-text text-muted small">
                                    تقرير شامل بجميع فواتير ضريبة الخصم والإضافة (5%)
                                </p>
                                <div class="btn-group w-100">
                                    <a href="{{ url_for('reports.withholding_report') }}" class="btn btn-warning">
                                        <i class="fas fa-eye me-1"></i>عرض
                                    </a>
                                    <a href="{{ url_for('reports.withholding_report', export='pdf') }}" class="btn btn-outline-warning">
                                        <i class="fas fa-file-pdf me-1"></i>PDF
                                    </a>
                                    <a href="{{ url_for('reports.withholding_report', export='excel') }}" class="btn btn-outline-warning">
                                        <i class="fas fa-file-excel me-1"></i>Excel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- تقرير المبيعات بدون ضرائب -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-money-bill-wave fa-3x text-success"></i>
                                </div>
                                <h6 class="card-title">تقرير المبيعات الصافية</h6>
                                <p class="card-text text-muted small">
                                    تقرير المبيعات الفعلية بدون الضرائب
                                </p>
                                <div class="btn-group w-100">
                                    <a href="{{ url_for('reports.sales_report') }}" class="btn btn-success">
                                        <i class="fas fa-eye me-1"></i>عرض
                                    </a>
                                    <a href="{{ url_for('reports.sales_report', export='pdf') }}" class="btn btn-outline-success">
                                        <i class="fas fa-file-pdf me-1"></i>PDF
                                    </a>
                                    <a href="{{ url_for('reports.sales_report', export='excel') }}" class="btn btn-outline-success">
                                        <i class="fas fa-file-excel me-1"></i>Excel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- التقرير الشامل -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-info">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-chart-pie fa-3x text-info"></i>
                                </div>
                                <h6 class="card-title">التقرير الشامل</h6>
                                <p class="card-text text-muted small">
                                    تقرير شامل بجميع أنواع الضرائب والمبيعات
                                </p>
                                <div class="btn-group w-100">
                                    <a href="{{ url_for('reports.comprehensive_report') }}" class="btn btn-info">
                                        <i class="fas fa-eye me-1"></i>عرض
                                    </a>
                                    <a href="{{ url_for('reports.comprehensive_report', export='pdf') }}" class="btn btn-outline-info">
                                        <i class="fas fa-file-pdf me-1"></i>PDF
                                    </a>
                                    <a href="{{ url_for('reports.comprehensive_report', export='excel') }}" class="btn btn-outline-info">
                                        <i class="fas fa-file-excel me-1"></i>Excel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- فلاتر التقارير -->
    <div class="col-xl-4">
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-filter me-2"></i>
                    فلاتر التقارير
                </h6>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('reports.reports_dashboard') }}" id="filterForm">
                    <div class="mb-3">
                        <label class="form-label">الفترة الزمنية</label>
                        <select name="period" class="form-select">
                            <option value="current_month" {{ 'selected' if period == 'current_month' }}>الشهر الحالي</option>
                            <option value="last_month" {{ 'selected' if period == 'last_month' }}>الشهر الماضي</option>
                            <option value="current_quarter" {{ 'selected' if period == 'current_quarter' }}>الربع الحالي</option>
                            <option value="current_year" {{ 'selected' if period == 'current_year' }}>السنة الحالية</option>
                            <option value="custom" {{ 'selected' if period == 'custom' }}>فترة مخصصة</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="customDateRange" style="{% if period == 'custom' %}display: block;{% else %}display: none;{% endif %}">
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label">من تاريخ</label>
                                <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
                            </div>
                            <div class="col-6">
                                <label class="form-label">إلى تاريخ</label>
                                <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-2"></i>
                        تطبيق الفلاتر
                    </button>
                </form>
            </div>
        </div>

        <!-- الإجراءات السريعة -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    إجراءات سريعة
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('reports.tax_declaration') }}" class="btn btn-success">
                        <i class="fas fa-file-contract me-2"></i>
                        إنشاء إقرار ضريبي
                    </a>
                    <a href="{{ url_for('reports.monthly_summary') }}" class="btn btn-info">
                        <i class="fas fa-calendar-alt me-2"></i>
                        ملخص شهري
                    </a>
                    <a href="{{ url_for('reports.yearly_summary') }}" class="btn btn-warning">
                        <i class="fas fa-calendar me-2"></i>
                        ملخص سنوي
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- الرسوم البيانية -->
<div class="row mt-4">
    <div class="col-xl-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    اتجاه الضرائب الشهري
                </h6>
            </div>
            <div class="card-body">
                <canvas id="taxTrendChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-xl-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    توزيع أنواع الضرائب
                </h6>
            </div>
            <div class="card-body">
                <canvas id="taxDistributionChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// بيانات الرسوم البيانية
const chartData = {
    monthlyLabels: {{ monthly_labels | tojson | safe }},
    monthlyVat: {{ monthly_vat | tojson | safe }},
    monthlyWithholding: {{ monthly_withholding | tojson | safe }},
    totalVat: {{ total_vat | default(0) }},
    totalWithholding: {{ total_withholding | default(0) }},
    totalSales: {{ total_sales | default(0) }}
};

document.addEventListener('DOMContentLoaded', function() {
    // إظهار/إخفاء نطاق التاريخ المخصص
    const periodSelect = document.querySelector('select[name="period"]');
    const customDateRange = document.getElementById('customDateRange');
    
    if (periodSelect && customDateRange) {
        periodSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customDateRange.style.display = 'block';
            } else {
                customDateRange.style.display = 'none';
            }
        });
    }
    
    // رسم بياني لاتجاه الضرائب
    const taxTrendCanvas = document.getElementById('taxTrendChart');
    if (taxTrendCanvas) {
        const taxTrendCtx = taxTrendCanvas.getContext('2d');
        new Chart(taxTrendCtx, {
            type: 'line',
            data: {
                labels: chartData.monthlyLabels || [],
                datasets: [{
                    label: 'ضريبة القيمة المضافة',
                    data: chartData.monthlyVat || [],
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    tension: 0.4
                }, {
                    label: 'ضريبة الخصم والإضافة',
                    data: chartData.monthlyWithholding || [],
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' جنيه';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // رسم بياني لتوزيع الضرائب
    const taxDistributionCanvas = document.getElementById('taxDistributionChart');
    if (taxDistributionCanvas) {
        const taxDistributionCtx = taxDistributionCanvas.getContext('2d');
        const salesWithoutTax = Math.max(0, chartData.totalSales - chartData.totalVat - chartData.totalWithholding);
        
        new Chart(taxDistributionCtx, {
            type: 'doughnut',
            data: {
                labels: ['ضريبة القيمة المضافة', 'ضريبة الخصم والإضافة', 'مبيعات بدون ضرائب'],
                datasets: [{
                    data: [chartData.totalVat, chartData.totalWithholding, salesWithoutTax],
                    backgroundColor: ['#0d6efd', '#ffc107', '#198754'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
